generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id               String           @id @default(uuid())
  email            String?          @unique
  walletAddress    String?          @unique
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  hotWallet        HotWallet?
  endpointPolicies EndpointPolicy[]
  transactions     Transaction[]
  pendingPayments  PendingPayment[]
}

model HotWallet {
  id                  String   @id @default(uuid())
  address             String   @unique
  encryptedPrivateKey String
  userId              String   @unique
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
}

model EndpointPolicy {
  id               String    @id @default(uuid())
  endpointPattern  String
  payFromHotWallet Boolean   @default(false)
  status           String    @default("active") // active, draft, archived
  userId           String
  user             User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  archivedAt       DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@unique([userId, endpointPattern])
}

model Transaction {
  id        String   @id @default(uuid())
  amount    Float
  endpoint  String
  txHash    String?
  network   String   @default("base")
  status    String   @default("pending")
  type      String   @default("payment")
  userId          String
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  responsePayload String?
  errorMessage    String?
  responseStatus  Int?
  createdAt       DateTime @default(now())
}

model PendingPayment {
  id                  String    @id @default(uuid())
  userId              String
  url                 String
  method              String    @default("GET")
  amount              Float
  paymentRequirements String    // JSON string of PaymentRequirements
  status              String    @default("pending") // pending, approved, rejected, expired, completed, failed
  signature           String?   // The EIP-712 signature once approved
  requestBody         String?   // Original request body
  requestHeaders      String?   // Original request headers as JSON string
  responsePayload     String?   // Response body after paid fetch
  responseStatus      Int?      // HTTP status code of the paid response
  txHash              String?   // Settlement transaction hash
  completedAt         DateTime? // When the payment was completed
  expiresAt           DateTime
  createdAt           DateTime  @default(now())
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}
